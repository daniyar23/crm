<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <title>CRM Lite</title>

        <style>
            body {
                margin: 0;
                font-family:
                    system-ui,
                    -apple-system,
                    BlinkMacSystemFont,
                    sans-serif;
                background: #f4f6f8;
            }

            .container {
                max-width: 720px;
                margin: 40px auto;
                background: darkseagreen;
                padding: 32px;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            }

            h1 {
                text-align: center;
            }

            h2 {
                margin-top: 32px;
            }

            input,
            select,
            button {
                width: 100%;
                padding: 10px 12px;
                margin-top: 8px;
                font-size: 14px;
                border-radius: 6px;
                border: 1px solid #ccc;
            }

            button {
                background: #4f46e5;
                color: white;
                border: none;
                cursor: pointer;
            }

            button:hover {
                background: #4338ca;
            }

            .danger {
                background: #dc2626;
            }

            .danger:hover {
                background: #b91c1c;
            }

            .card {
                background: #f9fafb;
                padding: 16px;
                border-radius: 8px;
                margin-top: 12px;
            }

            ul {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            li {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid #e5e7eb;
            }

            .muted {
                color: #6b7280;
                font-size: 14px;
            }
        </style>
    </head>

    <body>
        <div class="container">
            <h1>CRM Lite</h1>

            <!-- USERS -->
            <h2>Создание пользователя</h2>
            <input id="userName" placeholder="Имя" />
            <input id="userEmail" placeholder="Email" />
            <button onclick="createUser()">Создать пользователя</button>

            <h2>Активный пользователь</h2>
            <select id="userSelect" onchange="onUserSelect()">
                <option value="">— выберите пользователя —</option>
            </select>
            <button class="danger" onclick="deleteActiveUser()">
                Удалить пользователя
            </button>

            <div class="card" id="activeUser">Не выбран</div>

            <!-- COMPANIES -->
            <h2>Компании пользователя</h2>
            <input id="companyName" placeholder="Название компании" />
            <button onclick="createCompany()">Создать компанию</button>

            <div class="card">
                <ul id="companies">
                    <li class="muted">Пользователь не выбран</li>
                </ul>
            </div>
        </div>

        <script>
            let users = [];
            let companies = [];
            let activeUserId = null;

            /* USERS */

            async function loadUsers() {
                const res = await fetch("/api/users");
                users = await res.json();
                renderUserSelect();
            }

            function renderUserSelect() {
                const select = document.getElementById("userSelect");
                select.innerHTML =
                    '<option value="">— выберите пользователя —</option>';

                users.forEach((u) => {
                    const option = document.createElement("option");
                    option.value = u.id;
                    option.textContent = `${u.name} (${u.email})`;
                    select.appendChild(option);
                });
            }

            async function createUser() {
                const name = userName.value;
                const email = userEmail.value;

                await fetch("/api/users", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name, email }),
                });

                userName.value = "";
                userEmail.value = "";
                loadUsers();
            }

            async function deleteActiveUser() {
                if (!activeUserId) {
                    alert("Пользователь не выбран");
                    return;
                }

                if (!confirm("Удалить пользователя и все его компании?"))
                    return;

                await fetch(`/api/users/${activeUserId}`, {
                    method: "DELETE",
                });

                activeUserId = null;
                document.getElementById("activeUser").innerText = "Не выбран";

                loadUsers();
                loadCompanies();
            }

            /* ACTIVE USER */

            function onUserSelect() {
                const id = Number(userSelect.value);

                if (!id) {
                    activeUserId = null;
                    activeUser.innerText = "Не выбран";
                    renderCompanies();
                    return;
                }

                activeUserId = id;
                const user = users.find((u) => u.id === id);

                activeUser.innerText = `${user.name}\n${user.email}\nID: ${user.id}`;
                renderCompanies();
            }

            /* COMPANIES */

            async function loadCompanies() {
                const res = await fetch("/api/companies");
                companies = await res.json();
                renderCompanies();
            }

            function renderCompanies() {
                const ul = document.getElementById("companies");
                ul.innerHTML = "";

                if (!activeUserId) {
                    ul.innerHTML =
                        '<li class="muted">Пользователь не выбран</li>';
                    return;
                }

                const filtered = companies.filter(
                    (c) => c.user_id === activeUserId,
                );

                if (filtered.length === 0) {
                    ul.innerHTML = '<li class="muted">Компаний нет</li>';
                    return;
                }

                filtered.forEach((c) => {
                    const li = document.createElement("li");
                    li.innerHTML = `
                <span>${c.name}</span>
                <button class="danger" onclick="deleteCompany(${c.id})">✕</button>
            `;
                    ul.appendChild(li);
                });
            }

            async function createCompany() {
                if (!activeUserId) {
                    alert("Выберите пользователя");
                    return;
                }

                await fetch("/api/companies", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        name: companyName.value,
                        user_id: activeUserId,
                    }),
                });

                companyName.value = "";
                loadCompanies();
            }

            async function deleteCompany(id) {
                if (!confirm("Удалить компанию?")) return;

                await fetch(`/api/companies/${id}`, {
                    method: "DELETE",
                });

                loadCompanies();
            }

            /* INIT */
            loadUsers();
            loadCompanies();
        </script>
    </body>
</html>
